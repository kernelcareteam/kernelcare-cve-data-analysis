---
title: "Part 3 - Vulnerabilities by Version"
#subtitle: "My subtitle"
#author: "Extra information."
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: cosmo
---

# Introduction {#introduction}

In Part 2, I ran Mango queries on a CouchDB database full of CVEs, and had a good picture of how the number and severity of Linux kernel vulnerabilities varies from year to year. (Part 1 showed how to set up CouchDB and import CVE data into it on Ubuntu 18.04.)

In this part, Part 3, I develop that core Mango query to look at how the number of Linux kernel vulnerabilities varies by kernel version.

Because there are so many versions, the queries and commands start to get more complicated, and take longer to complete. So, for now, I will only vary the year and kernel version. Severity remains a parameter but I will query results for all severities.

Here is what I’ve added to the Mango query:

1. A selector for version (version.version_data) in the product.product_data block. It matches records when the version_value equals ($eq) a parameter (which I’ll pass in). This first parameter will be the kernel version for the query.
2. A version_affected selector. This is an operator that matches the version_value against either a range (&lt;=) or a specific value (=).
3. The publishedDate block time field is now time-zone independent. This is for edge cases, CVEs reported near midnight, and where your local timezone differs from that used by the NVD.

I’ll start by looking at the last five releases (2.6.35 to 2.6.39) of the famously long-running 2.6.x Linux kernel branch.

---

**Dash (-) as a value for version_value**

The official [NVD CVE JSON feed schema](https://csrc.nist.gov/schema/nvd/feed/1.1/CVE_JSON_4.0_min_1.1.schema) defines both version_value and version_affected as strings but doesn’t say what the possible values are. I looked at the source files and found that version_value is either a release number or a dash (-). But I couldn’t find any information on what a dash means. So, for now, the queries ignore any records with a dash in the version_value field.

---

# Query 2 - Linux kernel CVEs by year and kernel version {#query-2-linux-kernel-cves-by-year-and-kernel-version}

1. Put this query into qry/cve-query-2.json. \
```
{
    "selector": {
        "cve.affects.vendor.vendor_data": {
            "$allMatch": {
                "vendor_name": "linux",
                "product.product_data": {
                    "$allMatch": {
                        "product_name": "linux_kernel",
                        "version.version_data": {
                            "$elemMatch": {
                                "version_value": {
                                    "$eq": "%s"
                                },
                                "version_affected": {
                                    "$in": ["=","&lt;="]
                                }
                            }
                        }
                    }
                }
            }
        },
        "publishedDate": {
            "$gte": "%s-01-01T00:00Z",
            "$lte": "%s-12-31T23:59Z"
        },
        "impact.baseMetricV2.cvssV2.baseScore": {
            "$gte": %d,
            "$lte": %d
        }
    },
    "fields": ["cve.CVE_data_meta.ID"],
    "limit": 999999
}
```
2. Run this. It’s two nested for-loops. The outer loop (line 2) are the years 2015 to 2019 inclusive. They are used twice (line 8) as the second and third printf substitutions in the Mango query (in the publishedDate block) which is the date range for the query (January 1 to December 31 for the year). The inner loop (line 6) is the last five 2.6.x branch kernel version numbers (taken from [kernelnewbies.org](https://kernelnewbies.org/LinuxVersions) and defined on line 1). These are expanded by printf into values that match version_value. \
```
VERSIONS=(2.6.35 2.6.36 2.6.37 2.6.38 2.6.39)
(IFS=$'\t'; echo -e "Vers\t${VERSIONS[*]}" | tee out/cve-rep-2-26x.tsv); for YEAR in {2015..2019}
do
  RES=()
  echo -en "$YEAR\t"
  for VERS in ${VERSIONS[*]}
  do
    RES+=($(printf "$(cat qry/cve-query-2.json)" $VERS $YEAR $YEAR 0 10 |
        curl -sX POST -d @- http://127.0.0.1:5984/nvd/_find \
          --header "Content-Type:application/json" |
        json_pp | grep '"ID"' | wc -l))
    done
    (IFS=$'\t'; echo "${RES[*]}")
done | tee -a out/cve-rep-2-26x.tsv
```
3. The output is this. \
```
Vers	2.6.35	2.6.36	2.6.37	2.6.38	2.6.39
2015	6	6	6	6	6
2016	1	1	1	1	1
2017	9	9	9	10	10
2018	21	21	21	21	21
2019	74	74	73	73	73
```
4. Here is the gnuplot command (you’ll see in a moment why I’ve set the Y-axis scale maximum to 160). \
```
reset
set xtics 1
set key top left autotitle columnheader title "Kernel Version"
set title "Linux kernel CVEs by version (2.6.x)"
set xlabel "Year"; set ylabel "Number of CVEs"
plot [] [0:160] for [c=2:6] 'out/cve-rep-2-26x.tsv' using 1:c with lines lw 3
```
5. Here’s the chart.

![](images/image_10.png "image_tooltip")

6. Repeat for the last five releases of the other major branches by changing the value of VERSIONS:
    *   3.15 3.16 3.17 3.18 3.19 (Releases between 8 June 2014 and 8 February 2015)
    *   4.16 4.17 4.18 4.19 4.20 (1 April 2018 – 23 December 2018)
    *   5.0 5.1 5.2 5.3 5.4 (3 March 2019 – 24 November 2019)

Note: For each run, change the output file names (e.g. out/cve-rep-2-VER.tsv) on the second and last line of the command, and in the last line of the gnuplot command. Here are the charts with the same Y-axis scale as for 2.6.x.

![](images/image_11.png "image_tooltip")
 

![](images/image_12.png "image_tooltip")
 

![](images/image_13.png "image_tooltip")



# Conclusions {#conclusions}

Taken together, the complete set of graphs for all major Linux kernel branches seems to answer my original question: the safest Linux kernel (the one with fewest vulnerabilities) is the latest, version 5.4.

I also conclude:

*   with each major version, the total number of vulnerabilities decreases;
*   the big spike in 2017 was mainly due to vulnerabilities found in 3.18.
*   the effect of many vulnerabilities extends beyond branches and ‘End of Life’ dates. For example, for 2.6, the last release, [2.6.39](https://kernelnewbies.org/Linux_2_6_39), was in May 2011. It was designated ‘end of life’ at version 2.6.39.4 in [August the same year](http://lkml.iu.edu/hypermail/linux/kernel/1108.0/01203.html). Nevertheless, reports of vulnerabilities affecting it haven’t stopped, and have increased since 2016.


# Bonus 1 - CVEs for Linux kernel 2.6.x 2002–2019 {#bonus-1-cves-for-linux-kernel-2-6-x-2002–2019}

I was curious about what the entire 2.6 branch (2.6.0, released 18 December 2003, to 2.6.39, released 18 May 2011) looked like over the entire range of CVE data (2002 to 2019). Here it is.


![](images/image_14.png "image_tooltip")


# Bonus 2 - CVEs for Linux kernel 3.18 {#bonus-2-cves-for-linux-kernel-3-18}

I was also curious about the 3.18 release, and what proportion were which severity. For reference, here’s the correspondence between severity and base score numbers.

<!---
<table>
  <tr>
   <td>Severity
   </td>
   <td>Base Score Range
<p>

   </td>
  </tr>
  <tr>
   <td>Low
   </td>
   <td>0.0–3.9
   </td>
  </tr>
  <tr>
   <td>Medium
   </td>
   <td>4.0–6.9
   </td>
  </tr>
  <tr>
   <td>High
   </td>
   <td>7.0–10.0
   </td>
  </tr>
</table>
-->

| Severity | Base Score Range |
|----------|------------------|
| Low      | 0.0-3.9          |
| Medium   | 4.0-6.9          |
| High     | 7.0-10.0         |
|          |                  |

![](images/image_15.png "image_tooltip")


# Bonus 3 - CVE IDs for specified kernel and year {#bonus-3-cve-ids-for-specified-kernel-and-year}

To know what CVE IDs have affected a particular kernel in a certain year, use this command, setting the environment values accordingly.

```
VERS=2.6.39
YEAR=2019
MINSEV=0
MAXSEV=10
printf "$(cat qry/cve-query-2.json)" $VERS $YEAR $YEAR $MINSEV $MAXSEV | \
curl -sX POST -d @- http://127.0.0.1:5984/nvd/_find --header "Content-Type:application/json" | \
cut -d':' -f4 | tr -d '{}[]",' | sed '/^[[:space:]]*$/d' | sort
```

<div align="right">
Brought to you by [KernelCare](https://kernelcare.com).

Read more developer content in our blog: [blog.kernelcare.com](https://blog.kernelcare.com/)
</div>
